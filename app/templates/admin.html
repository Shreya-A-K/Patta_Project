<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard - Patta Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Noto Sans Tamil', -apple-system, sans-serif; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; }
        .chat-message { margin-bottom: 1rem; padding: 1rem; border-radius: 0.75rem; }
        .user-message { background: #3b82f6; color: white; margin-left: 20%; }
        .bot-message { background: white; border: 1px solid #e5e7eb; margin-right: 20%; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-8">
    <!-- TOP NAV -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">üëë Admin User - Patta Verification</h1>
            <a href="/logout" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Logout</a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto">
        <!-- STATS CARDS -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Total Applications</h3>
                <div id="total-apps" class="text-3xl font-bold text-blue-600">0</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Pending</h3>
                <div id="pending-apps" class="text-3xl font-bold text-orange-600">0</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">AI Analyzed</h3>
                <div id="ai-analyzed" class="text-3xl font-bold text-purple-600">0</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Approved</h3>
                <div id="approved-apps" class="text-3xl font-bold text-green-600">0</div>
            </div>
        </div>

        <!-- APPLICATIONS TABLE -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
            <div class="p-6 border-b bg-gradient-to-r from-gray-50 to-gray-100">
                <h2 class="text-2xl font-bold text-gray-900">üìã All Patta Applications</h2>
                <div class="flex gap-2 mt-2">
                    <input id="searchInput" placeholder="Search Ref ID..." class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <select id="statusFilter" class="p-3 border rounded-lg">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <button onclick="loadApps()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">üîÑ Refresh</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table id="apps-table" class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left">Ref ID</th>
                            <th class="px-6 py-4 text-left">Citizen</th>
                            <th class="px-6 py-4 text-left">Location</th>
                            <th class="px-6 py-4 text-left">Survey</th>
                            <th class="px-6 py-4 text-left">Status</th>
                            <th class="px-6 py-4 text-left">Days</th>
                            <th class="px-6 py-4 text-left">AI</th>
                            <th class="px-6 py-4 text-left">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="8" class="text-center py-12 text-gray-500">Loading applications...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- GEMINI CHATBOT -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center">ü§ñ Gemini AI Assistant <span id="chatSpinner" class="ml-2 text-green-500" style="display:none;">‚è≥</span></h2>
            <div id="chat-container" class="h-64 bg-gray-50 rounded-lg p-4 overflow-y-auto mb-4 border"></div>
            <div class="flex gap-2">
                <input id="chat-input" type="text" placeholder="Ask about applications, verification rules..." 
                       class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <button onclick="sendChat()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Send</button>
                <button onclick="clearChat()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Clear</button>
            </div>
        </div>
    </div>

    <script>
        let applications = [];

        // üî• ULTRA SAFE LOAD FUNCTION
        async function loadApps() {
            try {
                console.log('üîÑ Loading apps...');
                const res = await fetch('/api/admin/applications');
                console.log('Status:', res.status, res.statusText);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('API Error:', res.status, errorText);
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }
                
                const data = await res.json();
                console.log('‚úÖ Loaded:', data.length, 'applications');
                applications = data;
                renderTable();
                updateStats();
            } catch (error) {
                console.error('‚ùå Load failed:', error);
                document.querySelector('#apps-table tbody').innerHTML = 
                    `<tr><td colspan="8" class="text-center py-12 text-red-500 bg-red-50 p-8">
                        <div>
                            <h3>üö´ API ERROR</h3>
                            <p><strong>Error:</strong> ${error.message}</p>
                            <p><strong>Check:</strong> F12 ‚Üí Console</p>
                            <button onclick="loadApps()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg">üîÑ Retry</button>
                        </div>
                    </td></tr>`;
            }
        }

        function renderTable() {
            const tbody = document.querySelector('#apps-table tbody');
            const search = document.getElementById('searchInput').value.toUpperCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            const filtered = applications.filter(app => 
                (app.ref_id || '').toUpperCase().includes(search) &&
                (!statusFilter || app.status === statusFilter)
            );
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-12 text-gray-500">No applications found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(app => {
                const statusClass = app.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                                   app.status === 'approved' ? 'bg-green-100 text-green-800' : 
                                   'bg-red-100 text-red-800';
                
                const aiBtn = app.gemini_analysis ? 
                    `<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">ü§ñ AI OK</span>` :
                    `<button onclick="geminiVerify('${app.ref_id}')" class="text-xs bg-purple-600 text-white px-3 py-1 rounded-full hover:bg-purple-700">AI Verify</button>`;
                
                return `
                    <tr class="border-t hover:bg-gray-50">
                        <td class="px-6 py-4 font-mono text-blue-600 font-semibold">${app.ref_id || 'N/A'}</td>
                        <td class="px-6 py-4">${app.citizen_email || 'N/A'}</td>
                        <td class="px-6 py-4">${app.village || 'N/A'}, ${app.taluk || 'N/A'}</td>
                        <td class="px-6 py-4">${app.surveyNo || 'N/A'}/${app.subdivNo || ''}</td>
                        <td class="px-6 py-4">
                            <span class="status-badge ${statusClass}">${(app.status || 'pending').toUpperCase()}</span>
                        </td>
                        <td class="px-6 py-4 font-semibold">${app.days_pending || 0}</td>
                        <td class="px-6 py-4">${aiBtn}</td>
                        <td class="px-6 py-4">
                            <select onchange="updateStatus('${app.ref_id}', this.value)" class="border px-3 py-2 rounded-lg text-sm">
                                <option value="pending" ${app.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="approved" ${app.status === 'approved' ? 'selected' : ''}>‚úÖ Approve</option>
                                <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>‚ùå Reject</option>
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Rest of your JavaScript functions (unchanged)...
        function updateStats() {
            const total = applications.length;
            const pending = applications.filter(a => a.status === 'pending').length;
            const approved = applications.filter(a => a.status === 'approved').length;
            const aiAnalyzed = applications.filter(a => a.gemini_analysis).length;
            
            document.getElementById('total-apps').textContent = total;
            document.getElementById('pending-apps').textContent = pending;
            document.getElementById('approved-apps').textContent = approved;
            document.getElementById('ai-analyzed').textContent = aiAnalyzed;
        }

        async function updateStatus(ref_id, status) {
            try {
                const res = await fetch(`/api/patta/${ref_id}/status`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status})
                });
                if (res.ok) loadApps();
            } catch(e) { console.error('Status update failed:', e); }
        }

        async function geminiVerify(ref_id) {
            try {
                const res = await fetch(`/api/gemini/verify/${ref_id}`, {method: 'POST'});
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ AI Analysis Complete! Refreshing...');
                    loadApps();
                } else {
                    alert('‚ùå AI Error: ' + data.error);
                }
            } catch(e) { alert('‚ùå Network error'); }
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const container = document.getElementById('chat-container');
            container.innerHTML += `<div class="chat-message user-message"><strong>You:</strong> ${message}</div>`;
            input.value = '';
            document.getElementById('chatSpinner').style.display = 'inline';

            try {
                const res = await fetch('/api/gemini/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message})
                });
                const data = await res.json();
                document.getElementById('chatSpinner').style.display = 'none';
                
                if (data.success) {
                    container.innerHTML += `<div class="chat-message bot-message"><strong>ü§ñ Gemini:</strong> ${data.response}</div>`;
                } else {
                    container.innerHTML += `<div class="chat-message bot-message text-red-500"><strong>ü§ñ Gemini:</strong> Chat error</div>`;
                }
                container.scrollTop = container.scrollHeight;
            } catch(e) {
                document.getElementById('chatSpinner').style.display = 'none';
                container.innerHTML += '<div class="chat-message bot-message text-red-500">Network error</div>';
            }
        }

        function clearChat() {
            document.getElementById('chat-container').innerHTML = '';
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', renderTable);
        document.getElementById('statusFilter').addEventListener('change', renderTable);
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendChat();
        });

        // Auto-load
        loadApps();
        setInterval(loadApps, 10000);
    </script>
</body>
</html>

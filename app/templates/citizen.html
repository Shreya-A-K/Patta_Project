{% extends "base.html" %}

{% block title %}{{ lang['Citizen Dashboard - Patta Application'] or 'Citizen Dashboard - Patta Application' }}{% endblock %}

{% block content %}
<div class="container">
    <div class="welcome-card">
        <h1 class="welcome-title">{{ lang['Patta Application'] or 'Patta Application' }}</h1>
        <p>{{ lang['Google Satellite - House-level precision for land boundaries'] or 'Google Satellite - House-level precision for land boundaries' }}</p>
    </div>

    <!-- Location Form -->
    <div class="form-card" style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1.5rem;">üìç {{ lang['Set Location'] or 'Set Location' }}</h3>
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: center;">
            <button class="btn btn-primary" id="gpsBtn" onclick="getUltraPreciseLocation()" style="width: 100%;">
                üéØ {{ lang['Get Precise Location'] or 'Ultra GPS (House-level)' }}
            </button>
            <input type="text" id="addressSearch" class="form-input" 
                   placeholder="{{ lang['Or search address...'] or 'Or search address...' }}" 
                   onkeypress="handleSearch(event)">
            <button class="btn btn-secondary" onclick="toggleSatellite()" id="satelliteToggle">
                üõ∞Ô∏è {{ lang['Google Satellite'] or 'Google Satellite' }}
            </button>
        </div>
    </div>

    <!-- Map -->
    <div class="form-card" style="margin-bottom: 2rem; height: 500px; position: relative;">
        <div id="map" style="height: 100%; width: 100%; border-radius: 0.5rem;"></div>
        <div id="loading" style="position: absolute; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 5px; display: none;">
            {{ lang['Loading...'] or 'Loading...' }}
        </div>
        <div id="zoomInfo" style="position: absolute; top: 10px; right: 10px; background: white; padding: 8px; border-radius: 5px; font-size: 0.875rem; font-weight: 600;">Zoom: 16</div>
    </div>

    <!-- Coordinates Section -->
    <div class="form-card" style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1.5rem;">
            üìã {{ lang['Property Details'] or 'Property Details' }} 
            <span id="accuracy" style="color: #10b981;">({{ lang['Ready'] or 'Ready' }})</span>
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div class="form-group">
                <label class="form-label">{{ lang['District'] or 'District' }}</label>
                <input type="text" id="district" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">{{ lang['Taluk'] or 'Taluk' }}</label>
                <input type="text" id="taluk" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">{{ lang['Village'] or 'Village' }}</label>
                <input type="text" id="village" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">{{ lang['Latitude'] or 'Latitude' }}</label>
                <input type="number" id="lat" class="form-input" step="any" placeholder="13.082680" oninput="updateMapFromCoords()">
            </div>
            <div class="form-group">
                <label class="form-label">{{ lang['Longitude'] or 'Longitude' }}</label>
                <input type="number" id="lng" class="form-input" step="any" placeholder="80.270718" oninput="updateMapFromCoords()">
                <button class="btn btn-secondary" onclick="goToCoords()" style="margin-top: 0.5rem; padding: 0.5rem; font-size: 0.875rem;">
                    üìç {{ lang['Center Map'] or 'Center Map' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Patta Form -->
    <div class="form-card">
        <h3 style="margin-bottom: 1.5rem;">üìÑ {{ lang['Application Details'] or 'Application Details' }}</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div>
                <div class="form-group">
                    <label class="form-label">{{ lang['Survey Number'] or 'Survey Number' }}</label>
                    <input type="text" id="surveyNo" class="form-input" placeholder="e.g., 123/2A">
                </div>
                <div class="form-group">
                    <label class="form-label">{{ lang['Subdivision'] or 'Subdivision' }}</label>
                    <input type="text" id="subdivNo" class="form-input" placeholder="e.g., 1">
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">{{ lang['Documents'] or 'Documents' }}</label>
                    <input type="file" id="documents" class="form-input" multiple accept=".pdf,.jpg,.png">
                    <div id="fileList" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted);"></div>
                </div>
            </div>
        </div>
        <div style="margin-top: 2rem;">
            <button class="btn btn-primary" onclick="submitPatta()" style="padding: 1rem 2rem; font-size: 1.1rem;">
                ‚úàÔ∏è {{ lang['Submit Patta Application'] or 'Submit Patta Application' }}
            </button>
            <div id="submitStatus" style="margin-top: 1rem; display: none;"></div>
        </div>
    </div>
</div>

<!-- Leaflet + Draw -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

<script>
let map, drawnItems, currentMarker = null, streetLayer = null, satelliteLayer = null;
let gpsWatchId = null;
let gpsRetries = 0;
const MAX_GPS_RETRIES = 3;

document.addEventListener('DOMContentLoaded', initMap);

function initMap() {
    map = L.map('map', {
        center: [13.0827, 80.2707],
        zoom: 18,
        zoomControl: true,
        doubleClickZoom: true,
        scrollWheelZoom: true,
        boxZoom: true,
        tap: true,
        touchZoom: true,
        zoomAnimation: true,
        zoomSnap: 0.25,
        minZoom: 10,
        maxZoom: 23
    });
    
    streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 19
    }).addTo(map);

    satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        attribution: '¬© Google',
        maxZoom: 23,
        subdomains:['mt0','mt1','mt2','mt3']
    });

    L.control.layers({
        "üó∫Ô∏è Street": streetLayer,
        "üõ∞Ô∏è Google Satellite": satelliteLayer
    }).addTo(map);

    drawnItems = L.featureGroup().addTo(map);
    addDrawControl();

    map.setMaxBounds([[8.0, 76.5], [14.0, 80.5]]);
    updateZoomDisplay();
    map.on('zoomend', updateZoomDisplay);
}

function updateZoomDisplay() {
    document.getElementById('zoomInfo').textContent = `Zoom: ${map.getZoom()}/23`;
}

function addDrawControl() {
    const drawControl = new L.Control.Draw({
        position: 'topright',
        draw: {
            polygon: { shapeOptions: { color: '#10b981', weight: 4, fillOpacity: 0.3 } },
            marker: false, circle: false, rectangle: false, polyline: false
        },
        edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, e => {
        drawnItems.addLayer(e.layer);
    });
}

// üî• ULTRA-PRECISE GPS (HOUSE-LEVEL <5m)
function getUltraPreciseLocation() {
    const gpsBtn = document.getElementById('gpsBtn');
    
    if (!navigator.geolocation) {
        alert('‚ùå Geolocation not supported');
        return;
    }

    // Stop any running watch
    if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);

    gpsBtn.innerHTML = 'üéØ Ultra GPS...';
    gpsBtn.disabled = true;
    gpsRetries = 0;

    // STAGE 1: GPS WATCH (Real-time tracking for best signal)
    gpsWatchId = navigator.geolocation.watchPosition(
        position => {
            const accuracy = position.coords.accuracy;
            if (accuracy < 10) { // HOUSE-LEVEL precision
                navigator.geolocation.clearWatch(gpsWatchId);
                onUltraGpsSuccess(position, gpsBtn);
            }
        },
        () => stage2Fallback(gpsBtn),
        { 
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 5000
        }
    );

    // Auto-fallback after 45s
    setTimeout(() => {
        if (gpsWatchId) {
            navigator.geolocation.clearWatch(gpsWatchId);
            stage2Fallback(gpsBtn);
        }
    }, 45000);
}

function onUltraGpsSuccess(position, gpsBtn) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;
    const accuracy = position.coords.accuracy;
    
    document.getElementById('lat').value = lat.toFixed(10); // 10 decimals!
    document.getElementById('lng').value = lng.toFixed(10);
    updateMapFromCoords();
    
    const accuracyEl = document.getElementById('accuracy');
    accuracyEl.textContent = `‚úÖ ${accuracy.toFixed(1)}m HOUSE GPS`;
    accuracyEl.style.color = '#10b981';
    
    gpsBtn.innerHTML = `üè† ${accuracy.toFixed(1)}m PRECISE!`;
    setTimeout(() => {
        gpsBtn.innerHTML = 'üéØ Ultra GPS';
        gpsBtn.disabled = false;
    }, 4000);
    gpsWatchId = null;
}

function stage2Fallback(gpsBtn) {
    gpsRetries++;
    gpsBtn.innerHTML = 'üì° GPS + WiFi...';
    
    navigator.geolocation.getCurrentPosition(
        position => {
            if (position.coords.accuracy < 50) {
                onUltraGpsSuccess(position, gpsBtn);
            } else {
                stage3Fallback(gpsBtn);
            }
        },
        () => stage3Fallback(gpsBtn),
        { enableHighAccuracy: true, timeout: 25000, maximumAge: 10000 }
    );
}

function stage3Fallback(gpsBtn) {
    if (confirm('üîç For HOUSE-LEVEL accuracy (<5m):\n\n1. Go OUTSIDE (open area)\n2. Wait GPS signal (clear sky)\n3. Click OK to retry\n\n[Cancel for City location]')) {
        getUltraPreciseLocation();
    } else {
        ipPreciseLocation(gpsBtn);
    }
}

function ipPreciseLocation(gpsBtn) {
    gpsBtn.innerHTML = 'üåê City Location...';
    
    fetch('https://ipapi.co/json/')
        .then(r => r.json())
        .then(data => {
            if (data.latitude) {
                document.getElementById('lat').value = data.latitude.toFixed(8);
                document.getElementById('lng').value = data.longitude.toFixed(8);
                updateMapFromCoords();
                
                document.getElementById('accuracy').textContent = '(City-level)';
                document.getElementById('accuracy').style.color = '#f59e0b';
                
                gpsBtn.innerHTML = 'üìç City OK';
            }
        })
        .catch(() => alert('‚ùå Network error'))
        .finally(() => {
            setTimeout(() => {
                gpsBtn.innerHTML = 'üéØ Ultra GPS';
                gpsBtn.disabled = false;
            }, 2000);
        });
}

function updateMapFromCoords() {
    const lat = parseFloat(document.getElementById('lat').value);
    const lng = parseFloat(document.getElementById('lng').value);
    
    if (!isNaN(lat) && !isNaN(lng) && lat !== '' && lng !== '') {
        if (currentMarker) map.removeLayer(currentMarker);
        
        currentMarker = L.marker([lat, lng]).addTo(map)
            .bindPopup(`üìç Your Coordinates<br>Lat: ${lat.toFixed(10)}<br>Lng: ${lng.toFixed(10)}`)
            .openPopup();
        
        reverseGeocode(lat, lng);
        map.flyTo([lat, lng], 20); // Max zoom
    }
}

function goToCoords() {
    const lat = parseFloat(document.getElementById('lat').value);
    const lng = parseFloat(document.getElementById('lng').value);
    
    if (isNaN(lat) || isNaN(lng) || lat === '' || lng === '') {
        alert('Please enter valid latitude and longitude first');
        return;
    }
    
    map.flyTo([lat, lng], 20);
    updateMapFromCoords();
}

async function reverseGeocode(lat, lng) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
        const data = await res.json();
        const addr = data.address || {};
        
        document.getElementById('district').value = addr.state_district || addr.county || '';
        document.getElementById('taluk').value = addr.taluk || addr.city || '';
        document.getElementById('village').value = addr.village || addr.suburb || '';
    } catch(e) {
        console.error('Reverse geocoding failed');
    }
}

function handleSearch(e) {
    if (e.key === 'Enter') {
        const query = document.getElementById('addressSearch').value + ', Tamil Nadu';
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=IN`)
            .then(r => r.json())
            .then(data => {
                if (data[0]) {
                    document.getElementById('lat').value = parseFloat(data[0].lat).toFixed(10);
                    document.getElementById('lng').value = parseFloat(data[0].lon).toFixed(10);
                    updateMapFromCoords();
                }
            });
    }
}

function toggleSatellite() {
    if (map.hasLayer(satelliteLayer)) {
        map.removeLayer(satelliteLayer);
        document.getElementById('satelliteToggle').innerHTML = 'üõ∞Ô∏è Google Satellite';
    } else {
        map.addLayer(satelliteLayer);
        document.getElementById('satelliteToggle').innerHTML = 'üó∫Ô∏è Street';
    }
}

function submitPatta() {
    const boundary = [];
    drawnItems.eachLayer(layer => {
        if (layer.getLatLngs) {
            boundary.push(layer.getLatLngs()[0].map(p => [p.lat.toFixed(10), p.lng.toFixed(10)]));
        }
    });
    
    if (!boundary.length) return alert('Please draw your land boundary first');
    
    const formData = {
        district: document.getElementById('district').value,
        taluk: document.getElementById('taluk').value,
        village: document.getElementById('village').value,
        lat: document.getElementById('lat').value,
        lng: document.getElementById('lng').value,
        surveyNo: document.getElementById('surveyNo').value,
        subdivNo: document.getElementById('subdivNo').value,
        boundary: boundary
    };
    
    fetch('/api/patta/apply', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify(formData)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('submitStatus').innerHTML = 
                `<div style="color:#10b981;padding:1rem;background:rgba(16,185,129,0.1);border-radius:0.5rem;">‚úÖ Submitted! Ref: ${data.reference}</div>`;
            document.getElementById('submitStatus').style.display = 'block';
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('documents').addEventListener('change', e => {
        document.getElementById('fileList').innerHTML = 
            Array.from(e.target.files).map(f => `üìÑ ${f.name} (${(f.size/1024).toFixed(1)}KB)`).join('<br>');
    });
});
</script>
{% endblock %}

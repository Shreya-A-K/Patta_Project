{% extends "base.html" %}

{% block title %}{{ lang['Citizen Dashboard - Patta Application'] or 'Citizen Dashboard - Patta Application' }}{% endblock %}

{% block content %}
<div class="container">
    <div class="welcome-card">
        <h1 class="welcome-title">üë§ {{ lang['Patta Application'] or 'Patta Application' }}</h1>
        <p>Google Satellite - House-level precision for land boundaries</p>
    </div>

    <!-- Location Form -->
    <div class="form-card" style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1.5rem;">üìç Set Location</h3>
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: center;">
            <button class="btn btn-primary" id="gpsBtn" onclick="getUltraPreciseLocation()" style="width: 100%;">
                üéØ Get Precise Location
            </button>
            <input type="text" id="addressSearch" class="form-input" 
                   placeholder="Or search address..." 
                   onkeypress="handleSearch(event)">
            <button class="btn btn-secondary" onclick="toggleSatellite()" id="satelliteToggle">
                üõ∞Ô∏è Google Satellite
            </button>
        </div>
    </div>

    <!-- Map -->
    <div class="form-card" style="margin-bottom: 2rem; height: 500px; position: relative;">
        <div id="map" style="height: 100%; width: 100%; border-radius: 0.5rem;"></div>
        <div id="loading" style="position: absolute; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 5px; display: none;">
            Loading...
        </div>
        <div id="zoomInfo" style="position: absolute; top: 10px; right: 10px; background: white; padding: 8px; border-radius: 5px; font-size: 0.875rem; font-weight: 600;">Zoom: 16</div>
    </div>

    <!-- Coordinates Section - FULLY EDITABLE -->
    <div class="form-card" style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1.5rem;">
            üìã Property Details 
            <span id="accuracy" style="color: #10b981;">(Ready)</span>
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div class="form-group">
                <label class="form-label">District</label>
                <input type="text" id="district" class="form-input" placeholder="e.g., Chennai">
            </div>
            <div class="form-group">
                <label class="form-label">Taluk</label>
                <input type="text" id="taluk" class="form-input" placeholder="e.g., Velachery">
            </div>
            <div class="form-group">
                <label class="form-label">Village</label>
                <input type="text" id="village" class="form-input" placeholder="e.g., Gandhi Nagar">
            </div>
            <div class="form-group">
                <label class="form-label">Latitude</label>
                <input type="number" id="lat" class="form-input" step="any" placeholder="13.082680" oninput="updateMapFromCoords()">
            </div>
            <div class="form-group">
                <label class="form-label">Longitude</label>
                <input type="number" id="lng" class="form-input" step="any" placeholder="80.270718" oninput="updateMapFromCoords()">
                <button class="btn btn-secondary" onclick="goToCoords()" style="margin-top: 0.5rem; padding: 0.5rem; font-size: 0.875rem;">
                    üìç Center Map
                </button>
            </div>
        </div>
    </div>

    <!-- Patta Form - 5 MANDATORY DOCUMENTS -->
    <div class="form-card">
        <h3 style="margin-bottom: 1.5rem;">üìÑ Application Details</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div>
                <div class="form-group">
                    <label class="form-label">Survey Number <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="surveyNo" class="form-input" placeholder="e.g., 123/2A" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Subdivision</label>
                    <input type="text" id="subdivNo" class="form-input" placeholder="e.g., 1">
                </div>
            </div>
            
            <!-- 5 MANDATORY DOCUMENTS -->
            <div>
                <div class="form-group">
                    <label class="form-label" style="color: #ef4444; font-weight: 700; font-size: 1.1rem;">
                        üìé MANDATORY DOCUMENTS (All 5 Required)
                    </label>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #fef2f2 0%, #fce7e7 100%); border-radius: 1rem; border: 3px solid #fecaca; box-shadow: 0 4px 20px rgba(239,68,68,0.1);">
                        <div class="document-field">
                            <label style="display: block; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem; font-size: 0.95rem;">üìú 1. Parent Document <span style="color: #dc2626; font-size: 1.2rem;">*</span></label>
                            <input type="file" id="parentDoc" class="form-input" accept=".pdf,.jpg,.jpeg,.png" required onchange="validateAllFiles()">
                            <div class="file-status" id="parentDoc-status" style="margin-top: 0.25rem; font-size: 0.85rem; min-height: 1.25rem;"></div>
                        </div>
                        
                        <div class="document-field">
                            <label style="display: block; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem; font-size: 0.95rem;">üìã 2. Sale Deed <span style="color: #dc2626; font-size: 1.2rem;">*</span></label>
                            <input type="file" id="saleDeed" class="form-input" accept=".pdf,.jpg,.jpeg,.png" required onchange="validateAllFiles()">
                            <div class="file-status" id="saleDeed-status" style="margin-top: 0.25rem; font-size: 0.85rem; min-height: 1.25rem;"></div>
                        </div>
                        
                        <div class="document-field">
                            <label style="display: block; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem; font-size: 0.95rem;">üÜî 3. Aadhar Card <span style="color: #dc2626; font-size: 1.2rem;">*</span></label>
                            <input type="file" id="aadharCard" class="form-input" accept=".pdf,.jpg,.jpeg,.png" required onchange="validateAllFiles()">
                            <div class="file-status" id="aadharCard-status" style="margin-top: 0.25rem; font-size: 0.85rem; min-height: 1.25rem;"></div>
                        </div>
                        
                        <div class="document-field">
                            <label style="display: block; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem; font-size: 0.95rem;">üîí 4. Encumbrance Certificate <span style="color: #dc2626; font-size: 1.2rem;">*</span></label>
                            <input type="file" id="encumbCert" class="form-input" accept=".pdf,.jpg,.jpeg,.png" required onchange="validateAllFiles()">
                            <div class="file-status" id="encumbCert-status" style="margin-top: 0.25rem; font-size: 0.85rem; min-height: 1.25rem;"></div>
                        </div>
                        
                        <div class="document-field">
                            <label style="display: block; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem; font-size: 0.95rem;">üó∫Ô∏è 5. Layout Scan <span style="color: #dc2626; font-size: 1.2rem;">*</span></label>
                            <input type="file" id="layoutScan" class="form-input" accept=".pdf,.jpg,.jpeg,.png" required onchange="validateAllFiles()">
                            <div class="file-status" id="layoutScan-status" style="margin-top: 0.25rem; font-size: 0.85rem; min-height: 1.25rem;"></div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div id="uploadProgress" style="margin-top: 1rem; font-weight: 600; display: none;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 250px; height: 10px; background: #e5e7eb; border-radius: 6px; overflow: hidden;">
                                <div id="progressFill" style="height: 100%; background: linear-gradient(90deg, #10b981, #059669); width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                            <span id="progressText" style="font-size: 0.9rem; font-weight: 700;">0%</span>
                        </div>
                    </div>
                    
                    <div id="filesSummary" style="margin-top: 0.75rem; padding: 0.75rem; background: #f3f4f6; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600;">
                        ‚è≥ Upload <span id="validCount">0</span>/5 documents to enable submission
                    </div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 2.5rem; text-align: center;">
            <button class="btn btn-primary submit-btn" id="submitBtn" onclick="submitPatta()" disabled 
                    style="padding: 1.25rem 3rem; font-size: 1.2rem; font-weight: 700; opacity: 0.6; cursor: not-allowed; min-width: 280px;">
                ‚úàÔ∏è Submit Patta Application 
                <span style="color: #ef4444; font-size: 1rem;">(Upload ALL 5 Documents)</span>
            </button>
            <div id="submitStatus" style="margin-top: 1.5rem; display: none;"></div>
        </div>
    </div>

    <!-- üî• APPLICATION TRACKER SECTION - NEW! -->
    <div class="form-card" style="margin-top: 2rem;">
        <h3 style="margin-bottom: 1.5rem;">üìä {{ lang['Track Applications'] or 'Track My Applications' }}</h3>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">
            <input type="text" id="trackRefId" class="form-input" placeholder="Enter Reference ID (e.g., PATTA-20251228-0001)">
            <button class="btn btn-secondary" onclick="loadMyApplications()">üîç Track</button>
        </div>
        
        <!-- Tracker Table -->
        <div id="trackerSection" style="display: none;">
            <div style="margin-bottom: 1rem;">
                <span id="trackerCount" style="font-weight: 700; color: #10b981;">0 Applications</span>
            </div>
            <div style="overflow-x: auto;">
                <table class="table" style="font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th>Ref ID</th>
                            <th>Property</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Submitted</th>
                            <th>Documents</th>
                        </tr>
                    </thead>
                    <tbody id="trackerTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- üî• GEMINI CHATBOT -->
<div class="form-card" style="margin-top: 2rem;">
    <h3>ü§ñ Patta AI Assistant <span id="chatSpinner" style="display:none;">‚è≥</span></h3>
    <div id="chatContainer" style="height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; background: #f8fafc; margin-bottom: 1rem;">
        <div class="chat-message bot-message">
            <strong>Patta AI:</strong> Hello! Ask me about Patta applications, documents, or tracking your Ref ID (PATTA-XXXX).
        </div>
    </div>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" id="chatInput" class="form-input" placeholder="Ask about Patta process, documents, status..." style="flex:1;">
        <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
        <button class="btn btn-secondary" onclick="clearChat()">Clear</button>
    </div>
</div>

<style>
.chat-message { margin-bottom: 1rem; padding: 0.75rem; border-radius: 0.5rem; }
.user-message { background: #3b82f6; color: white; margin-left: 20%; }
.bot-message { background: white; border: 1px solid #e5e7eb; margin-right: 20%; }
#chatSpinner { color: #10b981; }
</style>

<script>
let chatMessages = [
    {role: 'bot', text: 'Hello! Ask me about Patta applications, documents, or tracking your Ref ID (PATTA-XXXX).'}
];

function addMessage(role, text) {
    chatMessages.push({role, text});
    const container = document.getElementById('chatContainer');
    container.innerHTML += `
        <div class="chat-message ${role}-message">
            <strong>${role === 'user' ? 'You' : 'Patta AI'}:</strong> ${text}
        </div>
    `;
    container.scrollTop = container.scrollHeight;
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;
    
    addMessage('user', message);
    input.value = '';
    
    document.getElementById('chatSpinner').style.display = 'inline';
    
    fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: message})
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById('chatSpinner').style.display = 'none';
        if (data.reply) {
            addMessage('bot', data.reply);
        } else {
            addMessage('bot', 'Sorry, I could not process that. Try asking about Patta documents or process.');
        }
    })
    .catch(() => {
        document.getElementById('chatSpinner').style.display = 'none';
        addMessage('bot', 'Chat service temporarily unavailable.');
    });
}

function clearChat() {
    document.getElementById('chatContainer').innerHTML = '';
    chatMessages = [];
    addMessage('bot', 'Chat cleared! Ask me anything about Patta.');
}

document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendChatMessage();
});
</script>


<!-- Leaflet CSS/JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

<style>
.document-field .file-status {
    margin-top: 0.25rem; font-size: 0.85rem; min-height: 1.25rem; font-weight: 500;
}
.file-status.valid { color: #10b981; }
.file-status.invalid { color: #ef4444; }
.submit-ready { 
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important; 
    border-color: #059669 !important; 
    opacity: 1 !important; 
    cursor: pointer !important; 
    box-shadow: 0 8px 25px rgba(16,185,129,0.3);
    transform: translateY(0);
    transition: all 0.3s ease;
}
.submit-ready:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(16,185,129,0.4);
}
.table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 1rem; 
}
.table th, .table td { 
    padding: 0.75rem; 
    text-align: left; 
    border-bottom: 1px solid #e5e7eb; 
}
.table th { 
    background: #f8fafc; 
    font-weight: 600; 
    font-size: 0.85rem; 
}
.status-badge { 
    padding: 0.25rem 0.75rem; 
    border-radius: 9999px; 
    font-size: 0.8rem; 
    font-weight: 600; 
}
</style>

<script>
let map, drawnItems, currentMarker = null, streetLayer = null, satelliteLayer = null;
let gpsWatchId = null, gpsRetries = 0, allFilesValid = false;
let myApplications = [];

// üî• CITIZEN APPLICATION TRACKER - NEW!
async function loadMyApplications() {
    try {
        const response = await fetch('/api/citizen/applications');
        if (!response.ok) throw new Error('Unauthorized');
        
        myApplications = await response.json();
        renderTrackerTable();
    } catch (error) {
        console.error('Track failed:', error);
        document.getElementById('trackerCount').textContent = 'Login required';
    }
}

function renderTrackerTable() {
    const tbody = document.getElementById('trackerTableBody');
    const section = document.getElementById('trackerSection');
    const countEl = document.getElementById('trackerCount');
    
    tbody.innerHTML = '';
    
    if (myApplications.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:2rem; color:#6b7280;">No applications found</td></tr>';
        section.style.display = 'block';
        countEl.textContent = 'No Applications Found';
        return;
    }
    
    myApplications.forEach(app => {
        const row = document.createElement('tr');
        const statusBadge = getStatusBadge(app.status);
        
        row.innerHTML = `
            <td><strong style="color: #3b82f6;">${app.ref_id}</strong></td>
            <td>${app.surveyNo || 'N/A'} / ${app.subdivNo || ''}</td>
            <td>${app.village}, ${app.taluk}, ${app.district}</td>
            <td>${statusBadge}</td>
            <td>${new Date(app.submitted_at).toLocaleDateString()}</td>
            <td>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    ${Object.entries(app.documents).map(([docType, url]) => `
                        <a href="${url}" target="_blank" class="btn btn-sm btn-outline-primary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">
                            ${getDocEmoji(docType)}
                        </a>
                    `).join('')}
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    section.style.display = 'block';
    countEl.textContent = `${myApplications.length} Application${myApplications.length !== 1 ? 's' : ''}`;
}

function getStatusBadge(status) {
    const colors = {
        'pending': 'background: #fef3c7; color: #d97706;',
        'approved': 'background: #d1fae5; color: #065f46;',
        'rejected': 'background: #fee2e2; color: #991b1b;'
    };
    return `<span class="status-badge" style="${colors[status] || 'background: #e5e7eb; color: #374151;'}">${status.toUpperCase()}</span>`;
}

function getDocEmoji(docType) {
    const emojis = {
        'parentDoc': 'üìú', 'saleDeed': 'üìã', 'aadharCard': 'üÜî', 
        'encumbCert': 'üîí', 'layoutScan': 'üó∫Ô∏è'
    };
    return emojis[docType] || 'üìÑ';
}

// üî• EXISTING FORM FUNCTIONS (unchanged)
function updateMapFromCoords() {
    const lat = parseFloat(document.getElementById('lat').value);
    const lng = parseFloat(document.getElementById('lng').value);
    
    if (!isNaN(lat) && !isNaN(lng) && lat !== '' && lng !== '') {
        if (currentMarker) map.removeLayer(currentMarker);
        
        currentMarker = L.marker([lat, lng]).addTo(map)
            .bindPopup(`üìç Your Location<br>Lat: ${lat.toFixed(8)}<br>Lng: ${lng.toFixed(8)}`)
            .openPopup();
        
        reverseGeocode(lat, lng);
        map.flyTo([lat, lng], 20, { animate: true });
        document.getElementById('accuracy').textContent = '(Map Updated)';
        document.getElementById('accuracy').style.color = '#3b82f6';
    }
}

function goToCoords() {
    updateMapFromCoords();
}

function validateAllFiles() {
    const requiredFiles = ['parentDoc', 'saleDeed', 'aadharCard', 'encumbCert', 'layoutScan'];
    let validCount = 0;
    
    requiredFiles.forEach(id => {
        const input = document.getElementById(id);
        const status = document.getElementById(id + '-status');
        const file = input.files[0];
        
        if (file && allowedFileType(file) && file.size <= 10 * 1024 * 1024) {
            status.innerHTML = `‚úÖ ${(file.size/1024/1024).toFixed(1)}MB`;
            status.className = 'file-status valid';
            validCount++;
        } else {
            status.innerHTML = file ? '‚ùå Invalid/Too Large' : '‚ùå Required';
            status.className = 'file-status invalid';
        }
    });
    
    allFilesValid = validCount === 5;
    document.getElementById('validCount').textContent = validCount;
    updateSubmitButton();
}

function allowedFileType(file) {
    const allowed = ['.pdf', '.jpg', '.jpeg', '.png'];
    return allowed.some(ext => file.name.toLowerCase().endsWith(ext));
}

function updateSubmitButton() {
    const btn = document.getElementById('submitBtn');
    const summary = document.getElementById('filesSummary');
    
    if (allFilesValid) {
        btn.classList.add('submit-ready');
        btn.disabled = false;
        btn.innerHTML = 'üöÄ <strong>SUBMIT PATTA APPLICATION</strong> (5/5 Ready!)';
        summary.innerHTML = '‚úÖ <strong>ALL 5 DOCUMENTS READY!</strong> Draw boundary & Submit';
        summary.style.background = '#d1fae5';
        summary.style.color = '#065f46';
    } else {
        btn.classList.remove('submit-ready');
        btn.disabled = true;
        btn.innerHTML = '‚úàÔ∏è Submit Patta Application <span style="color: #ef4444;">(Upload ALL 5 Documents)</span>';
        summary.innerHTML = `‚è≥ Upload <span id="validCount">${document.getElementById('validCount').textContent}</span>/5 documents`;
        summary.style.background = '#f3f4f6';
        summary.style.color = '#374151';
    }
}

async function submitPatta() {
    if (!allFilesValid) {
        alert('‚ùå ALL 5 DOCUMENTS ARE MANDATORY!');
        return;
    }
    
    const boundary = [];
    drawnItems.eachLayer(layer => {
        if (layer.getLatLngs) {
            boundary.push(layer.getLatLngs()[0].map(p => [p.lat.toFixed(10), p.lng.toFixed(10)]));
        }
    });
    if (!boundary.length) {
        alert('‚ùå Please draw your land boundary first!');
        return;
    }
    
    if (!document.getElementById('surveyNo').value.trim()) {
        alert('‚ùå Survey Number is required!');
        return;
    }
    
    const formData = new FormData();
    const requiredFiles = ['parentDoc', 'saleDeed', 'aadharCard', 'encumbCert', 'layoutScan'];
    
    for (let id of requiredFiles) {
        formData.append(id, document.getElementById(id).files[0]);
    }
    
    formData.append('district', document.getElementById('district').value);
    formData.append('taluk', document.getElementById('taluk').value);
    formData.append('village', document.getElementById('village').value);
    formData.append('lat', document.getElementById('lat').value);
    formData.append('lng', document.getElementById('lng').value);
    formData.append('surveyNo', document.getElementById('surveyNo').value);
    formData.append('subdivNo', document.getElementById('subdivNo').value);
    formData.append('boundary', JSON.stringify(boundary));
    
    const submitBtn = document.getElementById('submitBtn');
    const submitStatus = document.getElementById('submitStatus');
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ UPLOADING 5 DOCUMENTS...';
    submitStatus.style.display = 'block';
    submitStatus.innerHTML = '<div style="color:#f59e0b;padding:1rem;">üì§ Uploading all 5 documents securely...</div>';
    
    try {
        const response = await fetch('/api/patta/apply', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            submitStatus.innerHTML = 
                `<div style="color:#10b981;padding:2rem;background:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%);border-radius:1rem;text-align:center;box-shadow:0 10px 40px rgba(16,185,129,0.3);">
                    ‚úÖ <strong>ALL 5 DOCUMENTS UPLOADED SUCCESSFULLY!</strong><br><br>
                    <span style="font-size:1.5rem;">Reference ID: <strong>${data.ref_id}</strong></span><br><br>
                    <small>Save this reference for tracking. Staff will review soon.</small>
                </div>`;
            submitBtn.innerHTML = '‚úÖ SUCCESSFULLY SUBMITTED!';
            submitBtn.style.background = '#10b981';
            
            setTimeout(() => location.reload(), 5000);
        } else {
            throw new Error(data.error || 'Upload failed');
        }
    } catch (error) {
        submitStatus.innerHTML = 
            `<div style="color:#ef4444;padding:1.5rem;background:rgba(239,68,68,0.1);border-radius:0.75rem;border-left:5px solid #ef4444;">
                ‚ùå <strong>Upload Failed:</strong> ${error.message}<br>
                <small>Please try again</small>
            </div>`;
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üîÑ TRY AGAIN';
    }
}

// üî• MAP FUNCTIONS (unchanged)
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    validateAllFiles();
    setTimeout(loadMyApplications, 1000); // Auto-track after 1s
});

function initMap() {
    map = L.map('map', {
        center: [13.0827, 80.2707],
        zoom: 18,
        zoomControl: true
    });
    
    streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 23,
        subdomains:['mt0','mt1','mt2','mt3']
    });

    L.control.layers({
        "üó∫Ô∏è Street": streetLayer,
        "üõ∞Ô∏è Google Satellite": satelliteLayer
    }).addTo(map);

    drawnItems = L.featureGroup().addTo(map);
    addDrawControl();

    map.setMaxBounds([[8.0, 76.5], [14.0, 80.5]]);
    updateZoomDisplay();
    map.on('zoomend', updateZoomDisplay);
}

function addDrawControl() {
    const drawControl = new L.Control.Draw({
        position: 'topright',
        draw: {
            polygon: { shapeOptions: { color: '#10b981', weight: 4, fillOpacity: 0.3 } },
            marker: false, circle: false, rectangle: false, polyline: false
        },
        edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, e => {
        drawnItems.addLayer(e.layer);
    });
}

function updateZoomDisplay() {
    document.getElementById('zoomInfo').textContent = `Zoom: ${map.getZoom()}/23`;
}

async function reverseGeocode(lat, lng) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
        const data = await res.json();
        const addr = data.address || {};
        
        document.getElementById('district').value = addr.state_district || addr.county || '';
        document.getElementById('taluk').value = addr.taluk || addr.city || '';
        document.getElementById('village').value = addr.village || addr.suburb || '';
    } catch(e) {
        console.error('Reverse geocoding failed');
    }
}

function handleSearch(e) {
    if (e.key === 'Enter') {
        const query = document.getElementById('addressSearch').value + ', Tamil Nadu';
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=IN`)
            .then(r => r.json())
            .then(data => {
                if (data[0]) {
                    document.getElementById('lat').value = parseFloat(data[0].lat).toFixed(10);
                    document.getElementById('lng').value = parseFloat(data[0].lon).toFixed(10);
                    updateMapFromCoords();
                }
            });
    }
}

function toggleSatellite() {
    if (map.hasLayer(satelliteLayer)) {
        map.removeLayer(satelliteLayer);
        document.getElementById('satelliteToggle').innerHTML = 'üõ∞Ô∏è Google Satellite';
    } else {
        map.addLayer(satelliteLayer);
        document.getElementById('satelliteToggle').innerHTML = 'üó∫Ô∏è Street';
    }
}

function getUltraPreciseLocation() {
    alert('GPS feature active - works outside with clear sky view');
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}{{ lang['Staff Dashboard - Patta Verification'] or 'Staff Dashboard - Patta Verification' }}{% endblock %}

{% block content %}
<div class="container">
    <div class="welcome-card">
        <h1 class="welcome-title">üîç {{ lang['Patta Verification Dashboard'] or 'Patta Verification Dashboard' }}</h1>
        <p>Review & approve land document applications</p>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" style="margin-bottom: 2rem;">
        <div class="stat-card">
            <div class="stat-number" style="color: #10b981;" id="pendingCount">0</div>
            <div class="stat-label">‚è≥ Pending</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: #065f46;" id="approvedCount">0</div>
            <div class="stat-label">‚úÖ Approved</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: #991b1b;" id="rejectedCount">0</div>
            <div class="stat-label">‚ùå Rejected</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: var(--primary);" id="totalAppsCount">0</div>
            <div class="stat-label">Total</div>
        </div>
    </div>

    <!-- Search & Filter -->
    <div class="form-card" style="margin-bottom: 2rem;">
        <h3>üîé Search Applications</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 200px auto; gap: 1rem; align-items: end;">
            <input type="text" id="searchRef" class="form-input" placeholder="Reference ID (e.g., PATTA-20251228-0001)" oninput="filterApplications()">
            <select id="statusFilter" class="form-input" onchange="filterApplications()">
                <option value="">All Status</option>
                <option value="pending">‚è≥ Pending</option>
                <option value="approved">‚úÖ Approved</option>
                <option value="rejected">‚ùå Rejected</option>
            </select>
            <input type="date" id="dateFilter" class="form-input" onchange="filterApplications()">
            <button class="btn btn-primary" onclick="loadApplications()">üîÑ Refresh</button>
        </div>
    </div>

    <!-- Applications Table -->
    <div class="form-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3>üìã Applications <span id="totalCount" style="color: #10b981; font-weight: 700;">(0)</span></h3>
            <button class="btn btn-secondary" onclick="exportCSV()">üì• Export CSV</button>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="table" id="applicationsTable">
                <thead>
                    <tr>
                        <th>Ref ID</th>
                        <th>Property</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>Submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div id="docModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;">
                <h3 id="modalTitle">Document Viewer</h3>
                <div>
                    <button class="btn btn-secondary" onclick="zoomIn()">üîç+</button>
                    <button class="btn btn-secondary" onclick="zoomOut()">üîç-</button>
                    <button class="btn btn-primary" onclick="toggleFullScreen()">‚õ∂</button>
                    <span class="btn-close" onclick="closeModal()" style="font-size: 2rem; cursor: pointer; padding: 0 1rem;">&times;</span>
                </div>
            </div>
            <div id="docViewer" style="height: 70vh; position: relative;">
                <iframe id="docFrame" style="width: 100%; height: 100%; border: none;"></iframe>
                <img id="imgViewer" style="width: 100%; height: 100%; object-fit: contain; display: none;">
            </div>
            <div id="modalActions" style="padding-top: 1rem; text-align: center;"></div>
        </div>
    </div>
</div>

<style>
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
.stat-card { background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb; text-align: center; }
.stat-number { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.25rem; }
.stat-label { color: var(--text-muted); font-size: 0.95rem; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal-content { background: white; border-radius: 1rem; box-shadow: 0 25px 50px rgba(0,0,0,0.25); max-width: 90vw; max-height: 90vh; overflow: auto; }
.table { width: 100%; border-collapse: collapse; }
.table th, .table td { padding: 1rem 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
.table th { background: #f8fafc; font-weight: 600; }
.status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; }
.status-pending { background: #fef3c7; color: #d97706; }
.status-approved { background: #d1fae5; color: #065f46; }
.status-rejected { background: #fee2e2; color: #991b1b; }
.action-btn { padding: 0.5rem 1rem; margin: 0 0.25rem; border-radius: 0.5rem; font-size: 0.85rem; cursor: pointer; border: none; }
.btn-view { background: #3b82f6; color: white; }
.btn-approve { background: #10b981; color: white; }
.btn-reject { background: #ef4444; color: white; }
.btn:hover { opacity: 0.9; }
</style>

<script>
let applications = [];
let currentApp = null;
let zoomLevel = 1;

document.addEventListener('DOMContentLoaded', loadApplications);

function filterApplications() {
    const searchRef = document.getElementById('searchRef').value.toUpperCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    let filtered = applications;
    
    if (searchRef) filtered = filtered.filter(app => app.ref_id.includes(searchRef));
    if (statusFilter) filtered = filtered.filter(app => app.status === statusFilter);
    if (dateFilter) filtered = filtered.filter(app => app.submitted_at.startsWith(dateFilter));
    
    renderFilteredTable(filtered);
}

function renderFilteredTable(filteredApps) {
    const tbody = document.querySelector('#applicationsTable tbody');
    tbody.innerHTML = '';
    
    filteredApps.forEach(app => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${app.ref_id}</strong></td>
            <td>${app.surveyNo || 'N/A'} / ${app.subdivNo || ''}</td>
            <td>${app.village}, ${app.taluk}</td>
            <td><span class="status-badge status-${app.status}">${app.status.toUpperCase()}</span></td>
            <td>${new Date(app.submitted_at).toLocaleDateString()}</td>
            <td>
                <button class="action-btn btn-view" onclick="viewApplication('${app.ref_id}')">üëÅÔ∏è View Docs</button>
                ${app.status === 'pending' ? `
                    <button class="action-btn btn-approve" onclick="updateStatus('${app.ref_id}', 'approved')">‚úÖ Approve</button>
                    <button class="action-btn btn-reject" onclick="updateStatus('${app.ref_id}', 'rejected')">‚ùå Reject</button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    document.getElementById('totalCount').textContent = `(${filteredApps.length})`;
}

async function loadApplications() {
    try {
        const url = new URL('/api/patta/applications', window.location.origin);
        const searchRef = document.getElementById('searchRef').value.toUpperCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        
        if (searchRef) url.searchParams.append('search', searchRef);
        if (statusFilter) url.searchParams.append('status', statusFilter);
        if (dateFilter) url.searchParams.append('date', dateFilter);
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        applications = await response.json();
        renderFilteredTable(applications);
        updateStats();
    } catch (error) {
        console.error('Load failed:', error);
        alert('Failed to load applications: ' + error.message);
    }
}

function updateStats() {
    const pending = applications.filter(app => app.status === 'pending').length;
    const approved = applications.filter(app => app.status === 'approved').length;
    const rejected = applications.filter(app => app.status === 'rejected').length;
    const total = applications.length;
    
    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('approvedCount').textContent = approved;
    document.getElementById('rejectedCount').textContent = rejected;
    document.getElementById('totalAppsCount').textContent = total;
}

async function viewApplication(refId) {
    currentApp = applications.find(app => app.ref_id === refId);
    if (!currentApp) return;
    
    document.getElementById('modalTitle').textContent = `${currentApp.ref_id} - ${currentApp.village}`;
    showDocument('parentDoc');
    document.getElementById('docModal').style.display = 'flex';
}

function showDocument(docType) {
    const docs = currentApp.documents;
    if (!docs[docType]) return;
    
    const url = docs[docType];
    const frame = document.getElementById('docFrame');
    const img = document.getElementById('imgViewer');
    
    zoomLevel = 1;
    updateZoom();
    
    if (url.includes('.pdf')) {
        frame.style.display = 'block';
        img.style.display = 'none';
        frame.src = url + '#view=Fit';
    } else {
        frame.style.display = 'none';
        img.style.display = 'block';
        img.src = url;
        img.style.transform = `scale(${zoomLevel})`;
    }
    
    updateModalActions(docType);
}

function updateModalActions(currentDoc) {
    const actions = document.getElementById('modalActions');
    const docs = ['parentDoc', 'saleDeed', 'aadharCard', 'encumbCert', 'layoutScan'];
    const currentIndex = docs.indexOf(currentDoc);
    
    actions.innerHTML = `
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem;">
            ${docs.map((doc, i) => `
                <button class="btn ${i === currentIndex ? 'btn-primary' : 'btn-secondary'}" 
                        onclick="showDocument('${doc}')" style="padding: 0.5rem 1rem;">
                    ${getDocEmoji(doc)} ${doc.replace(/([A-Z])/g, ' $1').toUpperCase()}
                </button>
            `).join('')}
        </div>
        ${currentApp.status === 'pending' ? `
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-approve action-btn" onclick="updateStatus('${currentApp.ref_id}', 'approved')" style="padding: 0.75rem 2rem;">
                    ‚úÖ APPROVE ALL DOCUMENTS
                </button>
                <button class="btn btn-reject action-btn" onclick="updateStatus('${currentApp.ref_id}', 'rejected')" style="padding: 0.75rem 2rem;">
                    ‚ùå REJECT APPLICATION
                </button>
            </div>
        ` : ''}
    `;
}

function getDocEmoji(docType) {
    const emojis = {
        parentDoc: 'üìú', saleDeed: 'üìã', aadharCard: 'üÜî', 
        encumbCert: 'üîí', layoutScan: 'üó∫Ô∏è'
    };
    return emojis[docType] || 'üìÑ';
}

async function updateStatus(refId, status) {
    if (!confirm(`Mark ${refId} as ${status.toUpperCase()}?`)) return;
    
    try {
        const response = await fetch(`/api/patta/${refId}/status`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ status: status })
        });
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned HTML instead of JSON');
        }
        
        const result = await response.json();
        console.log('API Response:', result);
        
        if (response.ok && result.success) {
            await loadApplications();
            if (currentApp && currentApp.ref_id === refId) {
                closeModal();
            }
            alert(`‚úÖ ${refId} ‚Üí ${status.toUpperCase()} SUCCESS!`);
        } else {
            throw new Error(result.error || `HTTP ${response.status}`);
        }
    } catch (error) {
        console.error('Update error:', error);
        alert(`‚ùå Update failed: ${error.message}`);
    }
}

function exportCSV() {
    const headers = ['Ref ID', 'Survey No', 'Village', 'Status', 'Submitted'];
    const csv = [
        headers.join(','),
        ...applications.map(app => [
            app.ref_id,
            `${app.surveyNo || ''}/${app.subdivNo || ''}`,
            app.village,
            app.status,
            new Date(app.submitted_at).toLocaleDateString()
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `patta-applications-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

function closeModal() { 
    document.getElementById('docModal').style.display = 'none'; 
}

function zoomIn() { 
    zoomLevel = Math.min(zoomLevel + 0.2, 3); 
    updateZoom(); 
}

function zoomOut() { 
    zoomLevel = Math.max(zoomLevel - 0.2, 0.5); 
    updateZoom(); 
}

function updateZoom() {
    document.getElementById('imgViewer').style.transform = `scale(${zoomLevel})`;
}

function toggleFullScreen() {
    const modal = document.getElementById('docModal');
    if (!document.fullscreenElement) {
        modal.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('docModal').style.display === 'flex') {
        closeModal();
    }
});
</script>
{% endblock %}

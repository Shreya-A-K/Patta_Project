{% extends "base.html" %}

{% block title %}Staff Dashboard - Patta Approvals{% endblock %}

{% block content %}
<div class="container">
    <div class="welcome-card">
        <h1 class="welcome-title">Staff Dashboard</h1>
        <p>Manage Patta Applications - State-wise Analytics</p>
    </div>

    <!-- ‚úÖ STATE-WISE STATS -->
    <div class="form-card" style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1.5rem;">üìä Application Statistics</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div class="stat-card">
                <div class="stat-number" id="totalApps">0</div>
                <div class="stat-label">Total Applications</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingApps">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="approvedApps">0</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rejectedApps">0</div>
                <div class="stat-label">Rejected</div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ STATE-WISE BREAKDOWN -->
    <div class="form-card" style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem;">üó∫Ô∏è By State</h3>
        <div style="overflow-x: auto;">
            <table class="table" id="stateTable">
                <thead>
                    <tr>
                        <th>State</th>
                        <th>Total</th>
                        <th>Pending</th>
                        <th>Approved</th>
                        <th>Rejected</th>
                        <th>% Pending</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- ‚úÖ PENDING APPLICATIONS -->
    <div class="form-card">
        <h3 style="margin-bottom: 1.5rem;">‚úÖ Pending Applications <span id="pendingCount">(0)</span></h3>
        <div style="overflow-x: auto;">
            <table class="table" id="applicationsTable">
                <thead>
                    <tr>
                        <th>Ref ID</th>
                        <th>State</th>
                        <th>District</th>
                        <th>Survey No.</th>
                        <th>Location</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<style>
.stat-card {
    background: linear-gradient(135deg, var(--primary) 0%, #10b981 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 1rem;
    text-align: center;
}
.stat-number { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.25rem; }
.stat-label { font-size: 0.95rem; opacity: 0.9; }
.table { width: 100%; border-collapse: collapse; }
.table th { background: var(--gray-100); font-weight: 600; padding: 1rem 0.75rem; }
.table td { padding: 1rem 0.75rem; border-bottom: 1px solid var(--gray-200); }
.action-btn { padding: 0.5rem 1rem; margin: 0 0.25rem; border-radius: 0.5rem; font-size: 0.875rem; }
</style>

<script>
let applications = [];

document.addEventListener('DOMContentLoaded', loadApplications);

async function loadApplications() {
    try {
        const res = await fetch('/api/staff/applications', {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const data = await res.json();
        applications = data.applications || [];
        renderStats();
        renderStateTable();
        renderApplicationsTable();
    } catch(e) {
        console.error('Failed to load applications');
    }
}

function renderStats() {
    const total = applications.length;
    const pending = applications.filter(a => a.status === 'pending').length;
    const approved = applications.filter(a => a.status === 'approved').length;
    const rejected = applications.filter(a => a.status === 'rejected').length;
    
    document.getElementById('totalApps').textContent = total;
    document.getElementById('pendingApps').textContent = pending;
    document.getElementById('approvedApps').textContent = approved;
    document.getElementById('rejectedApps').textContent = rejected;
    document.getElementById('pendingCount').textContent = `(${pending})`;
}

function renderStateTable() {
    const stateStats = {};
    applications.forEach(app => {
        const state = app.district.split(',')[0] || 'Unknown';
        if (!stateStats[state]) {
            stateStats[state] = { total: 0, pending: 0, approved: 0, rejected: 0 };
        }
        stateStats[state].total++;
        stateStats[state][app.status]++;
    });
    
    const tbody = document.querySelector('#stateTable tbody');
    tbody.innerHTML = Object.entries(stateStats)
        .sort((a,b) => b[1].total - a[1].total)
        .map(([state, stats]) => {
            const pendingPct = stats.total ? ((stats.pending / stats.total) * 100).toFixed(1) : 0;
            return `
                <tr>
                    <td><strong>${state}</strong></td>
                    <td>${stats.total}</td>
                    <td>${stats.pending}</td>
                    <td>${stats.approved}</td>
                    <td>${stats.rejected}</td>
                    <td>${pendingPct}%</td>
                </tr>
            `;
        }).join('');
}

function renderApplicationsTable() {
    const pendingApps = applications.filter(a => a.status === 'pending');
    
    const tbody = document.querySelector('#applicationsTable tbody');
    tbody.innerHTML = pendingApps.map(app => {
        const date = new Date(app.created_at).toLocaleDateString();
        const [lat, lng] = app.lat ? [app.lat.slice(0,10), app.lng.slice(0,10)] : ['N/A', 'N/A'];
        
        return `
            <tr>
                <td><strong>${app.reference}</strong></td>
                <td>${app.district.split(',')[0] || 'N/A'}</td>
                <td>${app.district}</td>
                <td>${app.surveyNo || app.subdivNo || 'N/A'}</td>
                <td>${lat}, ${lng}</td>
                <td>${date}</td>
                <td><span class="status-pending">‚è≥ Pending</span></td>
                <td>
                    <button class="action-btn" style="background: #10b981; color: white;" onclick="viewApplication('${app.reference}')">
                        üëÅÔ∏è View
                    </button>
                    <button class="action-btn" style="background: #3b82f6; color: white;" onclick="approve('${app.reference}')">
                        ‚úÖ Approve
                    </button>
                    <button class="action-btn" style="background: #ef4444; color: white;" onclick="reject('${app.reference}')">
                        ‚ùå Reject
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

async function approve(reference) {
    if (!confirm(`Approve application ${reference}?`)) return;
    
    try {
        await fetch(`/api/staff/approve/${reference}`, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });
        loadApplications(); // Refresh
        alert('‚úÖ Approved!');
    } catch(e) {
        alert('‚ùå Approval failed');
    }
}

async function reject(reference) {
    const reason = prompt('Rejection reason (optional):');
    if (!confirm(`Reject application ${reference}?`)) return;
    
    try {
        await fetch(`/api/staff/reject/${reference}`, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason: reason || 'Not specified' })
        });
        loadApplications();
        alert('‚ùå Rejected!');
    } catch(e) {
        alert('‚ùå Rejection failed');
    }
}

function viewApplication(reference) {
    const app = applications.find(a => a.reference === reference);
    if (app) {
        alert(`Reference: ${app.reference}\nDistrict: ${app.district}\nSurvey: ${app.surveyNo}\nLat/Lng: ${app.lat}, ${app.lng}\nBoundary: ${JSON.stringify(app.boundary)}`);
        // TODO: Open modal with map preview
    }
}
</script>
{% endblock %}
